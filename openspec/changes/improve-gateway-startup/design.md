# 设计文档：完善网关代理服务启动逻辑

## Context
当前网关服务通过 CLI 工具启动（`ai-agent-router start`），Web UI 中的启动/停止按钮只是改变前端本地状态，没有实际控制服务。用户需要能够通过 Web 界面真正启动和停止服务，并且服务状态需要持久化。

## Goals / Non-Goals

### Goals
- 通过 Web UI 启动/停止网关服务
- 服务状态持久化，刷新页面后仍能正确显示
- 服务在后台持续运行，不依赖前端会话
- 支持服务状态实时同步

### Non-Goals
- 不支持通过 Web UI 启动多个服务实例（单实例运行）
- 不实现服务自动重启功能（本次不涉及）
- 不实现服务监控和告警（后续可扩展）

## Decisions

### Decision 1: 服务启动方式
**选择**: 通过 Node.js `child_process.spawn` 启动 CLI 命令作为子进程

**理由**:
- 复用现有的 CLI 启动逻辑，避免重复代码
- 子进程独立运行，不阻塞主进程
- 可以监听进程退出事件，自动更新状态

**替代方案考虑**:
- 直接在主进程中启动服务：会导致 Next.js 开发模式下的热重载问题
- 使用 PM2 等进程管理器：增加外部依赖，复杂度较高

### Decision 2: 服务状态存储
**选择**: 使用 SQLite 数据库存储服务状态（status, port, pid, started_at）

**理由**:
- 项目已使用 SQLite，无需引入新依赖
- 状态持久化，支持跨会话查询
- 可以记录服务启动历史

**替代方案考虑**:
- 仅使用内存存储：刷新页面后状态丢失
- 使用文件存储：需要处理文件锁和并发问题

### Decision 3: 状态同步机制
**选择**: 前端定期轮询 `/api/service/status` API（每 2-3 秒）

**理由**:
- 实现简单，无需 WebSocket 等复杂机制
- 对于服务状态这种低频变化足够
- 兼容性好，无需额外配置

**替代方案考虑**:
- WebSocket 实时推送：增加复杂度，当前场景不需要
- Server-Sent Events (SSE)：需要额外的连接管理

### Decision 4: 单实例防护
**选择**: 在启动前检查数据库中是否有运行中的服务记录，并验证进程是否真实存在

**理由**:
- 防止重复启动导致端口冲突
- 处理异常退出后数据库状态不一致的情况

**实现**:
1. 启动前查询数据库中的服务状态
2. 如果状态为运行中，检查进程是否真实存在（通过 pid）
3. 如果进程不存在，清理数据库状态，允许启动
4. 如果进程存在，拒绝启动并返回错误

### Decision 5: 进程管理
**选择**: 使用 Node.js 原生 `child_process` 模块，记录子进程 PID

**理由**:
- 无需外部依赖
- 可以精确控制进程生命周期
- 可以监听进程退出事件

**实现细节**:
- 使用 `spawn` 而非 `exec`，避免 shell 注入风险
- 分离 stdout/stderr，便于日志记录
- 监听 `exit` 事件，自动更新数据库状态

## Risks / Trade-offs

### Risk 1: 进程异常退出后状态不一致
**风险**: 如果服务进程异常退出（崩溃、被 kill），数据库状态可能仍显示为运行中

**缓解措施**:
- 启动前检查进程是否存在
- 定期健康检查（可选，本次不实现）
- 监听进程退出事件，自动更新状态

### Risk 2: 端口冲突
**风险**: 如果配置的端口已被其他进程占用，启动会失败

**缓解措施**:
- 启动前检测端口是否可用
- 返回清晰的错误信息
- 提示用户修改端口配置

### Risk 3: 并发启动请求
**风险**: 用户快速点击启动按钮，可能触发多个启动请求

**缓解措施**:
- 在服务管理器中添加启动锁（flag）
- 启动过程中禁用启动按钮
- 返回适当的错误信息

### Trade-off: 状态同步延迟
**权衡**: 轮询方式有 2-3 秒延迟，但实现简单

**接受**: 对于服务启动/停止这种低频操作，2-3 秒延迟可接受

## Migration Plan

### 步骤
1. 添加数据库 schema 和查询方法（向后兼容，不影响现有功能）
2. 实现服务管理器（独立模块，不影响现有代码）
3. 添加服务管理 API（新路由，不影响现有 API）
4. 修改 Web UI（仅修改启动/停止逻辑，其他功能不变）
5. 测试验证

### 回滚
- 如果出现问题，可以回退 Web UI 代码，恢复为仅改变本地状态
- 数据库 schema 可以保留，不影响其他功能
- 服务管理 API 可以禁用，不影响网关核心功能

## Open Questions

1. **服务日志输出**: 是否需要将服务进程的 stdout/stderr 输出到某个地方？当前 CLI 直接输出到控制台。
   - **决定**: 本次不实现日志收集，后续可扩展

2. **服务配置变更**: 如果用户在服务运行中修改了端口配置，是否需要自动重启服务？
   - **决定**: 本次不实现自动重启，用户需要手动停止后重新启动

3. **服务健康检查**: 是否需要定期检查服务是否健康（不仅仅是进程存在）？
   - **决定**: 本次不实现，仅检查进程是否存在
